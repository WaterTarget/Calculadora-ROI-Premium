<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ROI Calculator | Kioskos & Vending</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #020408;
            --surface: #0f1218;
            --surface-highlight: #1a1e26;
            --border: #272b36;
            --primary: #3b82f6;
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Layout & Container */
        .app-wrapper {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            width: 100%;
        }
        header {
            margin-bottom: 2.5rem;
            text-align: center;
        }
        h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 700;
            letter-spacing: -0.03em;
            margin: 0 0 0.75rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            color: var(--text-muted);
            font-size: 1rem;
            max-width: 60ch;
            margin: 0 auto;
        }
        .subtitle span.mono {
            background: rgba(255, 255, 255, 0.08);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            color: #cbd5e1;
        }
        /* Main Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 2rem;
            align-items: start;
        }
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Panels & Cards */
        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .panel h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* Controls Section */
        .control-group {
            margin-bottom: 1.25rem;
        }
        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            transition: color 0.2s;
        }
        .control-group:focus-within label {
            color: var(--primary);
        }
        select,
        input[type="number"] {
            width: 100%;
            background: var(--surface-highlight);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s ease;
            outline: none;
        }
        select:hover,
        input[type="number"]:hover {
            border-color: #4b5563;
        }
        select:focus,
        input[type="number"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }
        /* Buttons */
        .actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 2rem;
        }
        button {
            width: 100%;
            padding: 0.85rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active {
            transform: translateY(1px);
        }
        button#copyBtn {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        button#copyBtn:hover {
            opacity: 0.9;
        }
        button#resetBtn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        button#resetBtn:hover {
            border-color: #64748b;
            color: var(--text-main);
        }
        /* Results Section */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        @media (max-width: 768px) {
            .kpi-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .kpi-card {
            background: var(--surface-highlight);
            border: 1px solid rgba(255, 255, 255, 0.03);
            padding: 1.25rem;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0.7;
        }
        .kpi-card.highlight::before {
            background: var(--success);
        }
        .kpi-val {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }
        .kpi-lbl {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        /* Insights & Charts */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 800px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        .chart-box {
            background: var(--surface-highlight);
            border-radius: var(--radius);
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.02);
            position: relative;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }
        .chart-box canvas {
            flex: 1;
            max-height: 240px;
        }
        .risk-banner {
            grid-column: 1 / -1;
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .risk-banner.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }
        .risk-banner.danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
        }
        .risk-content strong {
            display: block;
            color: var(--text-main);
            margin-bottom: 0.25rem;
        }
        .risk-content p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        /* Small components */
        .tag {
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--primary);
        }
        .dot.purple {
            background-color: #a78bfa;
        }
        .disclaimer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: #526075;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <header>
            <h1>Calculadora de Rentabilidad</h1>
            <div class="subtitle">
                Proyecci√≥n financiera interactiva para modelos de negocio. <br>
                Datos base referenciados de <span class="mono">ROI - GTM-1.xlsx</span>.
            </div>
        </header>
        <main class="dashboard-grid">
            <!-- Left Panel: Configuration -->
            <aside class="panel">
                <div class="panel-header">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                        Configuraci√≥n
                    </h2>
                </div>
                <div class="control-group">
                    <label for="modelSelect">Modelo de Negocio</label>
                    <select id="modelSelect"></select>
                </div>
                <div class="control-group">
                    <label for="demandFactor">Factor de Demanda (0.3 - 2.0)</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input id="demandFactor" type="number" step="0.05" min="0.30" max="2.00" value="1.00">
                        <span class="tag" title="Escenario"><span class="dot"></span>Escenario</span>
                    </div>
                    <small style="color:var(--text-muted); font-size:0.75rem; margin-top:6px; display:block;">1.0 =
                        Base, 0.8 = Conservador, 1.2 = Agresivo</small>
                </div>
                <div class="controls-grid" id="controls">
                    <!-- JS Injects inputs here -->
                </div>
                <div class="actions">
                    <button id="resetBtn">Restaurar Valores por Defecto</button>
                    <button id="copyBtn">Copiar Reporte a WhatsApp</button>
                </div>
            </aside>
            <!-- Right Panel: Results & Viz -->
            <section>
                <!-- KPIs -->
                <div class="kpi-row">
                    <div class="kpi-card">
                        <div class="kpi-val" id="kpiSales">$0</div>
                        <div class="kpi-lbl">Ventas / Margen</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-val" id="kpiCosts">$0</div>
                        <div class="kpi-lbl">Costos Fijos</div>
                    </div>
                    <div class="kpi-card highlight">
                        <div class="kpi-val" style="color:var(--success)" id="kpiProfit">$0</div>
                        <div class="kpi-lbl">Utilidad Mensual</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-val" id="kpiPayback">‚Äî</div>
                        <div class="kpi-lbl">Recuperaci√≥n</div>
                    </div>
                </div>
                <!-- Insight Banner -->
                <div class="risk-banner" id="riskBanner">
                    <div style="background:rgba(255,255,255,0.2); padding:8px; border-radius:50%">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                            <polyline points="13 2 13 9 20 9"></polyline>
                        </svg>
                    </div>
                    <div class="risk-content">
                        <strong id="insightTitle">Analizando...</strong>
                        <p id="insightBody">Ajusta los valores para ver el an√°lisis.</p>
                    </div>
                </div>
                <!-- Charts -->
                <div class="charts-container">
                    <div class="panel chart-box">
                        <div class="panel-header" style="border:none; padding:0 0 10px; margin:0;">
                            <h2 style="font-size:0.9rem; color:var(--text-muted)">Flujo de Efectivo Acumulado</h2>
                            <div class="tag"><span class="dot"></span> Proyecci√≥n 24 meses</div>
                        </div>
                        <canvas id="cashChart"></canvas>
                    </div>
                    <div class="panel chart-box">
                        <div class="panel-header" style="border:none; padding:0 0 10px; margin:0;">
                            <h2 style="font-size:0.9rem; color:var(--text-muted)">Retorno Anual</h2>
                            <div class="tag"><span class="dot purple"></span> ROI %</div>
                        </div>
                        <canvas id="roiChart"></canvas>
                    </div>
                </div>
                <div class="disclaimer">
                    * Nota: En modelos "Ventana Limpieza" y "Croquetas/Granos/Caf√©", la calculadora usa (Ganancia/u √ó Volumen) como Ventas Mensuales.
                </div>
            </section>
        </main>
    </div>
    <script>
        /* 
           LOGIC PRESERVED 100% 
           Only colors in Chart config updated for Dark Theme
        */
        const MODELS = {
            "kiosko_duo": { "inv": 244000, "price_ice": 25, "loads_m": 750, "price_gar": 15, "gar_m": 1500, "luz": 4950, "agua": 2475, "mnt": 825, "renta": 5000 },
            "c7": { "inv": 79000, "price_gar": 15, "gar_m": 1500, "luz": 900, "agua": 1800, "mnt": 300, "renta": 5000 },
            "c12": { "inv": 119000, "price_gar": 15, "gar_m": 1500, "luz": 900, "agua": 1800, "mnt": 300, "renta": 0 },
            "c17": { "inv": 49000, "gain_unit": 8, "lit_day": 150, "days": 30, "price_sale": 25, "luz": 500, "agua": 800, "mnt": 200, "renta": 2000 },
            "c22": { "inv": 95000, "gain_unit": 20, "kg_day": 50, "days": 30, "price_sale": 50, "luz": 800, "agua": 400, "mnt": 300, "renta": 3000 },
            "c27": { "inv": 217000, "price_ice": 25, "loads_m": 750, "luz": 3150, "agua": 1575, "mnt": 525, "renta": 0 },
            "c32": { "inv": 125000, "price_gar": 20, "gar_m": 3000, "luz": 3600, "agua": 1800, "mnt": 600, "renta": 5000, "sueldo": 18000 }
        };
        const MODEL_NAMES = { 
            "kiosko_duo": "KIOSKO DUO 130 GPD / 450 KG", 
            "c7": "KIOSKO 130 GPD", 
            "c12": "VENDING AGUA 130 GPD", 
            "c17": "VENTANA LIMPIEZA ($49,000)", 
            "c22": "CROQUETAS/GRANOS/CAF√â ($95,000 - 3 MAQ)", 
            "c27": "VENTANA Y VENDING HIELO", 
            "c32": "CENTRO DE LLENADO" 
        };
        const fmtMoney = (n) => {
            if (!isFinite(n)) return "‚Äî";
            return new Intl.NumberFormat("es-MX", { style: "currency", currency: "MXN", maximumFractionDigits: 0 }).format(n);
        };
        const fmtNum = (n, d = 2) => {
            if (!isFinite(n)) return "‚Äî";
            return new Intl.NumberFormat("es-MX", { maximumFractionDigits: d, minimumFractionDigits: d }).format(n);
        };
        function deepCopy(obj) { return JSON.parse(JSON.stringify(obj)); }
        let state = {
            modelId: Object.keys(MODELS)[0],
            demandFactor: 1.0,
            inputs: deepCopy(MODELS[Object.keys(MODELS)[0]])
        };
        const inputSchema = {
            kiosko_duo: [
                ["inv", "Inversi√≥n (MXN)", 0, 2000000, 1000],
                ["price_ice", "Precio bolsa Ice (MXN)", 0, 200, 1],
                ["loads_m", "Bolsas / mes (base)", 0, 10000, 10],
                ["price_gar", "Precio garraf√≥n (MXN)", 0, 200, 1],
                ["gar_m", "Garrafones / mes (base)", 0, 20000, 10],
                ["luz", "Luz / mes", 0, 200000, 50],
                ["agua", "Agua / mes", 0, 200000, 50],
                ["mnt", "Mantenimiento / mes", 0, 200000, 50],
                ["renta", "Renta / mes", 0, 200000, 50],
            ],
            c7: [
                ["inv", "Inversi√≥n (MXN)", 0, 2000000, 1000],
                ["price_gar", "Precio garraf√≥n (MXN)", 0, 200, 1],
                ["gar_m", "Garrafones / mes (base)", 0, 20000, 10],
                ["luz", "Luz / mes", 0, 200000, 50],
                ["agua", "Agua / mes", 0, 200000, 50],
                ["mnt", "Mantenimiento / mes", 0, 200000, 50],
                ["renta", "Renta / mes", 0, 200000, 50],
            ],
            c12: [
                ["inv", "Inversi√≥n (MXN)", 0, 2000000, 1000],
                ["price_gar", "Precio garraf√≥n (MXN)", 0, 200, 1],
                ["gar_m", "Garrafones / mes (base)", 0, 20000, 10],
                ["luz", "Luz / mes", 0, 200000, 50],
                ["agua", "Agua / mes", 0, 200000, 50],
                ["mnt", "Mantenimiento / mes", 0, 200000, 50],
                ["renta", "Renta / mes", 0, 200000, 50],
            ],
            c17: [
                ["inv", "Inversi√≥n (MXN)", 0, 2000000, 1000],
                ["gain_unit", "Margen por litro (MXN)", 0, 200, 1],
                ["lit_day", "Litros / d√≠a (base)", 0, 5000, 5],
                ["days", "D√≠as operativos / mes", 1, 31, 1],
                ["luz", "Luz / mes", 0, 200000, 50],
                ["agua", "Agua / mes", 0, 200000, 50],
                ["mnt", "Mantenimiento / mes", 0, 200000, 50],
                ["renta", "Renta / mes", 0, 200000, 50],
            ],
            c22: [
                ["inv", "Inversi√≥n (MXN)", 0, 2000000, 1000],
                ["gain_unit", "Margen por kg (MXN)", 0, 300, 1],
                ["kg_day", "Kg / d√≠a (base)", 0, 2000, 1],
                ["days", "D√≠as operativos / mes", 1, 31, 1],
                ["luz", "Luz / mes", 0, 200000, 50],
                ["agua", "Agua / mes", 0, 200000, 50],
                ["mnt", "Mantenimiento / mes", 0, 200000, 50],
                ["renta", "Renta / mes", 0, 200000, 50],
            ],
            c27: [
                ["inv", "Inversi√≥n (MXN)", 0, 2000000, 1000],
                ["price_ice", "Precio bolsa 5kg (MXN)", 0, 200, 1],
                ["loads_m", "Bolsas / mes (base)", 0, 10000, 10],
                ["luz", "Luz / mes", 0, 200000, 50],
                ["agua", "Agua / mes", 0, 200000, 50],
                ["mnt", "Mantenimiento / mes", 0, 200000, 50],
                ["renta", "Renta / mes", 0, 200000, 50],
            ],
            c32: [
                ["inv", "Inversi√≥n (MXN)", 0, 2000000, 1000],
                ["price_gar", "Precio garraf√≥n (MXN)", 0, 200, 1],
                ["gar_m", "Garrafones / mes (base)", 0, 50000, 10],
                ["luz", "Luz / mes", 0, 200000, 50],
                ["agua", "Agua / mes", 0, 200000, 50],
                ["mnt", "Mantenimiento / mes", 0, 200000, 50],
                ["renta", "Renta / mes", 0, 200000, 50],
                ["sueldo", "Nomina / mes", 0, 500000, 100],
            ],
        };
        function calc(modelId, inputs, demandFactor) {
            const x = inputs;
            const df = demandFactor;
            let inv = +x.inv || 0;
            let sales = 0;
            let fixed = 0;
            let profit = 0;
            if (modelId === "kiosko_duo") {
                const loads = (+x.loads_m || 0) * df;
                const gars = (+x.gar_m || 0) * df;
                sales = (+x.price_ice || 0) * loads + (+x.price_gar || 0) * gars;
                fixed = (+x.luz || 0) + (+x.agua || 0) + (+x.mnt || 0) + (+x.renta || 0);
                profit = sales - fixed;
            } else if (modelId === "c7" || modelId === "c12") {
                const gars = (+x.gar_m || 0) * df;
                sales = (+x.price_gar || 0) * gars;
                fixed = (+x.luz || 0) + (+x.agua || 0) + (+x.mnt || 0) + (+x.renta || 0);
                profit = sales - fixed;
            } else if (modelId === "c17") {
                const litrosMes = (+x.lit_day || 0) * (+x.days || 30) * df;
                sales = (+x.gain_unit || 0) * litrosMes;
                fixed = (+x.luz || 0) + (+x.agua || 0) + (+x.mnt || 0) + (+x.renta || 0);
                profit = sales - fixed;
            } else if (modelId === "c22") {
                const kgMes = (+x.kg_day || 0) * (+x.days || 30) * df;
                sales = (+x.gain_unit || 0) * kgMes;
                fixed = (+x.luz || 0) + (+x.agua || 0) + (+x.mnt || 0) + (+x.renta || 0);
                profit = sales - fixed;
            } else if (modelId === "c27") {
                const loads = (+x.loads_m || 0) * df;
                sales = (+x.price_ice || 0) * loads;
                fixed = (+x.luz || 0) + (+x.agua || 0) + (+x.mnt || 0) + (+x.renta || 0);
                profit = sales - fixed;
            } else if (modelId === "c32") {
                const gars = (+x.gar_m || 0) * df;
                sales = (+x.price_gar || 0) * gars;
                fixed = (+x.luz || 0) + (+x.agua || 0) + (+x.mnt || 0) + (+x.renta || 0) + (+x.sueldo || 0);
                profit = sales - fixed;
            }
            const payback = (profit > 0 && inv > 0) ? inv / profit : Infinity;
            const roiAnnual = (inv > 0) ? (profit * 12) / inv : Infinity;
            return { inv, sales, fixed, profit, payback, roiAnnual };
        }
        function paybackLabel(m) {
            if (!isFinite(m)) return "‚àû";
            if (m < 0) return "Nunca";
            return `${fmtNum(m, 1)} meses`;
        }
        function insight(metrics) {
            const { profit, payback, roiAnnual } = metrics;
            // Visual tweaks for risk banner
            const banner = document.getElementById("riskBanner");
            banner.className = "risk-banner";
            if (!isFinite(payback) || profit <= 0) {
                banner.classList.add("danger");
                return {
                    title: "Alerta: Flujo Negativo",
                    body: "Con estos par√°metros el modelo no genera utilidades. Intenta subir la demanda o reducir costos fijos."
                };
            }
            let speed = payback <= 6 ? "R√°pida" : (payback <= 12 ? "Media" : "Lenta");
            let roiTxt = roiAnnual >= 2 ? "Excelentes" : (roiAnnual >= 1 ? "Buenos" : "Moderados");
            if (roiAnnual < 0.5) banner.classList.add("warning");
            return {
                title: `Recuperaci√≥n ${speed}`,
                body: `Generas ${fmtMoney(profit)} libres al mes. Recuperas tu inversi√≥n en ${fmtNum(payback, 1)} meses. Rendimientos ${roiTxt} (${fmtNum(roiAnnual * 100, 0)}% anual).`
            };
        }
        const modelSelect = document.getElementById("modelSelect");
        const controls = document.getElementById("controls");
        const demandFactorInput = document.getElementById("demandFactor");
        function buildModelOptions() {
            modelSelect.innerHTML = "";
            Object.keys(MODELS).forEach(id => {
                const opt = document.createElement("option");
                opt.value = id;
                opt.textContent = MODEL_NAMES[id] || id;
                modelSelect.appendChild(opt);
            });
        }
        function buildControls() {
            controls.innerHTML = "";
            const schema = inputSchema[state.modelId] || [];
            schema.forEach(([key, label, min, max, step]) => {
                const wrapper = document.createElement("div");
                wrapper.className = "control-group";
                wrapper.style.marginBottom = "0";
                wrapper.innerHTML = `<label>${label}</label>`;
                const inp = document.createElement("input");
                inp.type = "number";
                inp.step = step;
                inp.min = min;
                inp.max = max;
                inp.value = (state.inputs[key] ?? 0);
                inp.addEventListener("input", () => {
                    state.inputs[key] = +inp.value;
                    render();
                });
                wrapper.appendChild(inp);
                controls.appendChild(wrapper);
            });
        }
        let cashChart, roiChart;
        function initCharts() {
            const ctx1 = document.getElementById("cashChart").getContext("2d");
            const ctx2 = document.getElementById("roiChart").getContext("2d");
            // Premium Dark Theme Colors
            const gridColor = "rgba(255,255,255,0.05)";
            const textColor = "#94a3b8";
            // Gradient for Line Chart
            let gradient = ctx1.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
            cashChart = new Chart(ctx1, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: "Flujo acumulado",
                            data: [],
                            borderColor: "#3b82f6",
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        },
                        {
                            label: "Inversi√≥n Inicial",
                            data: [],
                            borderColor: "#ef4444",
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 1
                        },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: textColor, font: { family: 'Inter' } } },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10
                        }
                    },
                    scales: {
                        x: { grid: { color: gridColor }, ticks: { color: textColor, font: { family: 'Inter' } } },
                        y: { grid: { color: gridColor }, ticks: { color: textColor, font: { family: 'Inter' } } }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
            roiChart = new Chart(ctx2, {
                type: "bar",
                data: {
                    labels: ["ROI Anual Estimado"],
                    datasets: [
                        {
                            label: "ROI",
                            data: [0],
                            backgroundColor: "#a78bfa",
                            hoverBackgroundColor: "#8b5cf6",
                            borderRadius: 6
                        },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.2,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f8fafc',
                            callbacks: {
                                label: (ctx) => `Rendimiento: ${fmtNum(ctx.parsed.y * 100, 0)}%`
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            grid: { color: gridColor },
                            ticks: { color: textColor, font: { family: 'Inter' }, callback: (v) => (v * 100).toFixed(0) + "%" },
                            suggestedMax: 2
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }
        function updateCharts(metrics) {
            const months = 24;
            const labels = Array.from({ length: months }, (_, i) => `Mes ${i + 1}`);
            let acc = 0;
            const series = [];
            for (let i = 1; i <= months; i++) {
                acc += metrics.profit;
                series.push(acc);
            }
            cashChart.data.labels = labels;
            cashChart.data.datasets[0].data = series;
            cashChart.data.datasets[1].data = labels.map(_ => metrics.inv);
            cashChart.update();
            roiChart.data.datasets[0].data = [metrics.roiAnnual];
            roiChart.options.scales.y.suggestedMax = Math.max(2, metrics.roiAnnual * 1.2);
            roiChart.update();
        }
        function render() {
            const metrics = calc(state.modelId, state.inputs, state.demandFactor);
            document.getElementById("kpiSales").textContent = fmtMoney(metrics.sales);
            document.getElementById("kpiCosts").textContent = fmtMoney(metrics.fixed);
            document.getElementById("kpiProfit").textContent = fmtMoney(metrics.profit);
            document.getElementById("kpiPayback").textContent = paybackLabel(metrics.payback);
            const ins = insight(metrics);
            document.getElementById("insightTitle").textContent = ins.title;
            document.getElementById("insightBody").textContent = ins.body;
            updateCharts(metrics);
        }
        function setModel(id) {
            state.modelId = id;
            state.inputs = deepCopy(MODELS[id]);
            buildControls();
            render();
        }
        modelSelect.addEventListener("change", (e) => setModel(e.target.value));
        demandFactorInput.addEventListener("input", (e) => {
            state.demandFactor = Math.max(0.3, Math.min(2.0, +e.target.value || 1));
            render();
        });
        document.getElementById("resetBtn").addEventListener("click", () => {
            state.inputs = deepCopy(MODELS[state.modelId]);
            state.demandFactor = 1.0;
            demandFactorInput.value = "1.00";
            buildControls();
            render();
        });
        document.getElementById("copyBtn").addEventListener("click", async () => {
            const m = calc(state.modelId, state.inputs, state.demandFactor);
            const text = `*Reporte ROI - ${MODEL_NAMES[state.modelId]}*\n\n` +
                `üí∞ Inversi√≥n: ${fmtMoney(m.inv)}\n` +
                `üìà Ventas/Margen: ${fmtMoney(m.sales)}\n` +
                `üìâ Costos Fijos: ${fmtMoney(m.fixed)}\n` +
                `‚úÖ *Utilidad Mensual: ${fmtMoney(m.profit)}*\n` +
                `üóìÔ∏è Recuperaci√≥n: ${paybackLabel(m.payback)}\n` +
                `üöÄ ROI Anual: ${fmtNum(m.roiAnnual * 100, 0)}%`;
            try {
                await navigator.clipboard.writeText(text);
                alert("Copiado al portapapeles. Listo para WhatsApp.");
            } catch {
                prompt("Copia este texto:", text);
            }
        });
        buildModelOptions();
        initCharts();
        setModel(state.modelId);
    </script>
</body>
</html>